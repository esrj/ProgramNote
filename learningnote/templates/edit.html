{% extends 'note.html' %}

{%block content%}
<body class="docs sidenav-pinned ready loaded">
    <div class="container-fluid container-docs">
        <div class="container">
            <div style="padding-top: 25px" class="col-xl-12 docs-content pb-5">
                <div class="docs-title">
                    {% if edit %}
                        <h1>編輯此貼文</h1>
                        <p class="lead mb-0">貼文主題 : {{theme.title}} <br> 貼文次標題 : <span>{{note_obj.subTheme.title}}</span></p>
                    {% else %}
                        <h1>新增筆記</h1>
                        <p class="lead mb-0">貼文主題 : {{theme.title}} <br> 貼文次標題 : <span>{{sub}}</span></p>
                    {% endif %}
                </div>

                <h5 >筆記標題</h5>
                <div  class="form-group">
                    <div class="input-group">
                        <input id = "title" type="text" class="form-control" placeholder="請在此輸入標題" value="{{note_obj.title}}" />
                    </div>
                </div>
                <h5 >說明</h5>
                <div  class="form-group">
                    <div class="input-group">
                        <textarea id = "text" rows="10" type="text" class="form-control" placeholder="請在此輸入說明" aria-label="Recipient's username" aria-describedby="basic-addon2">{{note_obj.text}}</textarea>
                    </div>
                </div>
                <h5 >程式碼</h5>
                <div  class="form-group">
                    <div class="input-group">
                        <textarea  id = "code" rows="20" type="text" class="form-control" placeholder="請在此程式碼" aria-label="Recipient's username" aria-describedby="basic-addon2">{{note_obj.code}}</textarea>
                    </div>
                </div>
                {% if edit %}
                    <button onclick="edit_()" style="float: right;padding: 0.5rem 1.75rem;" type="button" class="btn btn-primary btn-icon">
                        <span class="btn-inner--text">確認更改</span>
                    </button>
                    <button  onclick="delete_()" style="float: right;padding: 0.5rem 1.75rem;margin-right: 5px" type="button" class="btn btn-youtube ">
                        <span  class="btn-inner--text">刪除</span>
                    </button>
                {% else %}
                    <button onclick="new_()" style="float: right;padding: 0.5rem 1.75rem" type="button" class="btn btn-primary btn-icon">
                        <span class="btn-inner--text">新增</span>
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.6/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
<script>
    function edit_(){
        let urlParams = new URLSearchParams(window.location.search);
        let url = window.location.href
        axios({
            url:url,
            method:'POST',
            data:{
                'title':$('#title').val().trimEnd().replace('\n',''),
                'text':$('#text').val(),
                'code':$('#code').val()
            },
            headers:{'X-CSRFToken': "{{ csrf_token }}"}
        }).then(()=>{
            swal({
                'title':'更改成功',
                'icon':'success',
                'text':'正在跳轉至筆記頁面',
                'button': false,
                'timer': 1500
            })
            setTimeout(()=>{
                window.location = `/note/page/?theme=${urlParams.get('theme')}&page={{note_obj.subTheme.title}}`
            },1500)
        })
    }

    function delete_(){
        swal({
            title:'確定要刪除嗎？',
            text:'一旦刪除便無法復原，若仍要刪除請在輸入匡中輸入 "delete"',
            icon:'warning',
            content:'input',
            buttons: ['取消','確認']
        }).then(value=>{
            let urlParams = new URLSearchParams(window.location.search);
            url = `/note/deleteNote/`
            console.log(value)
            if(value === 'delete'){
                axios({
                    url: url,
                    method:'POST',
                    data:{
                        theme:urlParams.get('theme'),
                        subTheme:'{{note_obj.subTheme.title}}',
                        noteTitle:urlParams.get('page'),
                    },
                    headers:{'X-CSRFToken': "{{ csrf_token }}"}
                }).then(()=>{
                    swal({
                        title:'已刪除',
                        text:'正在為您到導回筆記頁面',
                        icon:'warning',
                        buttons: false,
                        timer:1500
                    })
                    setTimeout(()=>{
                        location.href = `/note/page/?theme=${urlParams.get('theme')}&page={{note_obj.subTheme.title}}`
                    })
                })
            }
        })
    }


    function new_(){
        console.log($('#title').val()&&$('#text').val()&&$('#code').val())
        if($('#title').val().trimEnd().replace('\n','')===''||$('#text').val()===''||$('#code').val()===''){
            swal({
                'title':'請先完成表單',
                'icon':'info',
                'text':'  ',
                'button': false,
                'timer': 1500
            })
        }else{
            let urlParams = new URLSearchParams(window.location.search);
            url = `/note/createNote/?theme=${urlParams.get('theme')}&page=${urlParams.get('page')}`
            axios({
                url:url,
                method:'POST',
                data:{
                    'title':$('#title').val().trimEnd().replace('\n',''),
                    'text':$('#text').val(),
                    'code':$('#code').val()
                },
                headers:{'X-CSRFToken': "{{ csrf_token }}"}
            }).then((res)=>{
                if(res.data.errno === 1){
                    swal({
                        'title':'請先建立章節',
                        'icon':'info',
                        'text':'正在跳轉至筆記頁面',
                        'button': false,
                        'timer': 1500
                    })
                }else{
                     swal({
                        'title':'新增成功',
                        'icon':'success',
                        'text':'正在跳轉至筆記頁面',
                        'button': false,
                        'timer': 1500
                    })
                }
                setTimeout(()=>{
                    window.location = `/note/page/?theme=${urlParams.get('theme')}&page={{sub}}`
                },1500)
            })
        }
    }

</script>


{% endblock %}